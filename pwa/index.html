<!DOCTYPE html>
<html lang="en-US" dir="ltr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="./assets/manifest.json">
  <!-- Using idb library: https://github.com/jakearchibald/idb   -->
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="styling.css">
  <title>Service Worker Auditer</title>
</head>

<body>
  <div>
    <!-- <div aria-live="polite" aria-atomic="true" style="position: relative; min-height: 200px;">
      <div id="sync-complete" class="toast" style="position: absolute; top: 0; right: 0;">
        <div class="toast-header">
          <small class="mr-auto">Sync Update</small>
          <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body">
          Sync Complete
        </div>
      </div>
    </div> -->
    <form id="json-to-send">
      <label for="json-input">JSON to send</label>
      <textarea id="json-input">
    </textarea>
      <div id="buttons">
        <button type="button" id="create" class="btn btn-primary btn-sm">Create Database</button>
        <button type="button" id="send" class="btn btn-primary btn-sm">Save to Queue</button>
        <button type="button" id="sync" class="btn btn-primary btn-sm">Attempt Sync</button>
      </div>
      <output name="output-message" id="output-message" for="input-temp input-unit output-unit">Press button</output>
    </form>
  </div>
  <script type="module" src="database.js"></script>
  <script type="module" src="formHandler.js"></script>
  <script type="module">
    import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs';
    const syncButton = document.getElementById('sync');
    if ('serviceWorker' in navigator) {
      console.log('Registering Service Worker...');
      const wb = new Workbox('sw.js', {
        type: 'module',
      });
      wb.register();
      syncButton.addEventListener("click", async () => {
        console.log('triggering sync');
        const registration = await navigator.serviceWorker.ready;
        const messageResponse = await registration.sync.register('TRIGGER_SYNC');
        // const messageResponse = await wb.messageSW({ type: 'TRIGGER_SYNC' });
        $('#sync-complete').toast('show');
      });
      navigator.serviceWorker.ready.then(registration => {
        if (registration.periodicSync) {
          // Periodic Background Sync is supported.
          const status = navigator.permissions.query({ name: 'periodic-background-sync' })
            .then(status => {
              console.log({ status });
              if (status.state === 'granted') {
                const interval = 15 * 1000;

                console.log(`Registering PeriodicSync every ${interval / 1000} seconds`);
                // Periodic background sync can be used.
                return registration.periodicSync.register(
                  'PERIODIC_SYNC', {
                  minInterval: interval,
                });
              } else {
                // Periodic background sync cannot be used.
                return Promise.reject('No permission!');
              }
            }).catch(error => {
              console.error({ error });
            });

        } else {
          // Periodic Background Sync isn't supported.
        }
      });

    } else {
      console.log('Service Worker not supported...');
    }
  </script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js"
    integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js"
    integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
    crossorigin="anonymous"></script>
</body>

</html>